name: Docker Build

on:
  push:
    branches-ignore:
      - master
      - 'hotfix-*'

permissions:
  contents: read

jobs:
  build:
    name: Build Docker Image
    runs-on: Linux
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Get git metadata
        id: vars
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "GIT_COMMIT=$COMMIT_HASH" >> $GITHUB_ENV
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG_VERSION=${GITHUB_REF#refs/tags/}
            echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_ENV
          fi

      - name: Login to Docker registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

      - name: Start MongoDB container
        run: |
          docker run -d --name mongodb -p 27017:27017 ${{ secrets.MONGO_RS_IMAGE }}
          # Get Mongo container IP for docker build
          MONGO_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' mongodb)
          echo "MONGO_IP=$MONGO_IP" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.IMAGE_NAME }}:${{ env.GIT_COMMIT }}
          build-args: |
            MONGO_URL=mongodb://mongodb:27017
          add-hosts: |
            mongodb:${{ env.MONGO_IP }}
          cache-to: type=local,dest=/tmp/.buildx-cache-new
            
      - name: Cleanup MongoDB
        if: always()
        run: |
          docker stop mongodb
          docker rm mongodb